# エリア管理機能 ガイド

## 🎯 概要

釣果記録アプリに**エリア管理機能**を追加しました！

自分専用の釣り場（エリア・場所・ポイント）を自由に追加・削除できるようになりました。

---

## ✨ 新機能

### 1. **AREAタブ**
- ナビゲーションに新しく「AREA」タブを追加
- LOG / DATA / AREA / SET の4つのタブで切り替え可能

### 2. **エリア管理画面**
- **エリア・場所・ポイントの追加**
  - エリア名（例：大阪湾エリア）
  - 場所名（例：新しい堤防）
  - ポイント名（例：先端）※任意
  
- **登録済みエリアの一覧表示**
  - エリアごとにグループ化して表示
  - 場所ごとに整理
  - ポイントは箇条書きで表示

- **削除機能**
  - ユーザーが追加したエリアのみ削除可能
  - 初期データ（北港エリアなど）は削除不可で保護
  - ゴミ箱アイコンをクリックで削除

### 3. **釣果記録画面との連携**
- エリアを追加すると、釣果記録画面のドロップダウンに自動反映
- 既存の初期データ + ユーザーが追加したデータの両方が表示される

---

## 📊 Supabaseテーブル構造

### `fishing_areas` テーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| `id` | UUID | 主キー（自動生成） |
| `user_id` | UUID | ユーザーID（NULL = 全員共通の初期データ） |
| `area_name` | TEXT | エリア名（例：北港エリア） |
| `location_name` | TEXT | 場所名（例：スリット） |
| `point_name` | TEXT | ポイント名（例：関門）※NULL可 |
| `is_default` | BOOLEAN | 初期データフラグ（true = 削除不可） |
| `created_at` | TIMESTAMP | 作成日時 |
| `updated_at` | TIMESTAMP | 更新日時 |

---

## 🔐 セキュリティ（RLS ポリシー）

- **閲覧**: 自分のデータ + 初期データ（`is_default = true`）
- **追加**: 自分のデータのみ
- **更新**: 自分のデータのみ
- **削除**: 自分のデータのみ

初期データは誰でも見れるが、編集・削除は不可。

---

## 🚀 使い方

### 1. エリアを追加する

1. 「AREA」タブを開く
2. 「➕ 新しいエリアを追加」セクションに入力
   - **エリア名**: 必須（例：大阪湾エリア）
   - **場所名**: 必須（例：新しい堤防）
   - **ポイント名**: 任意（例：先端）
3. 「追加」ボタンをクリック
4. 成功したら「エリアを追加しました」のトーストが表示される

### 2. エリアを削除する

1. 「📋 登録済みエリア一覧」から削除したいエリアを探す
2. ゴミ箱アイコン（🗑️）をクリック
3. 確認ダイアログで「OK」を選択
4. 削除されると「エリアを削除しました」のトーストが表示される

**注意**: 初期データ（北港エリアなど）には削除ボタンが表示されません。

### 3. 釣果記録で使う

1. 「LOG」タブを開く
2. 「エリアを選択」ドロップダウンを開く
3. 追加したエリアが表示される
4. 選択すると、場所とポイントのドロップダウンも自動更新される

---

## 📂 変更されたファイル

### 1. `index.html`
- AREAタブを追加（136行目）
- エリア管理画面のHTMLを追加（447-490行目）

### 2. `src/main.ts`
- `COMBINED_FISHING_DATA` 変数を追加（326行目）
- `loadFishingData()` 関数を追加（328-374行目）
  - Supabaseからデータを取得して初期データと統合
- `initLayer1()` 関数を更新（377-390行目）
  - 統合データを使用
- `FishingArea` 型を定義（1576-1586行目）
- `loadAreas()` 関数を追加（1588-1688行目）
  - エリア一覧を表示
- `addArea()` 関数を追加（1696-1748行目）
  - エリアを追加
- `deleteArea()` 関数を追加（1750-1777行目）
  - エリアを削除

### 3. `supabase_setup_v2.sql`
- `fishing_areas` テーブルの作成SQL
- RLSポリシーの設定
- 初期データの投入

---

## 🎨 UI/UX

### デザイン
- ダークテーマに統合
- グリーンの追加ボタン（#28a745）
- レッドの削除アイコン（#ff4444）
- エリアごとにグループ化して見やすく表示

### トースト通知
- 追加成功: 「エリアを追加しました」
- 削除成功: 「エリアを削除しました」
- エラー: 赤いトーストで表示

---

## 🔄 データフロー

```
1. ユーザーがエリアを追加
   ↓
2. Supabaseの fishing_areas テーブルに保存
   ↓
3. loadAreas() でエリア一覧を再読み込み
   ↓
4. initLayer1() で釣果記録画面のドロップダウンを更新
   ↓
5. 釣果記録画面で新しいエリアが選択可能に
```

---

## 📝 初期データ

以下のエリアが初期データとして登録されています（削除不可）：

- 北港エリア
  - スリット
  - 堤防
  - 貝塚
  - etc...
- 中京エリア
- 久保渡船
- 大勘渡船
- その他エリア

すべて `is_default = true` で保護されています。

---

## 🧪 テスト方法

### 1. ローカルでテスト
```bash
cd /home/user/webapp/record-fishing-practice
npm run dev
```

### 2. エリア追加をテスト
- AREAタブを開く
- 「大阪湾エリア」「新しい堤防」「先端」を入力
- 追加ボタンをクリック
- 一覧に表示されることを確認

### 3. 釣果記録画面をテスト
- LOGタブを開く
- エリアドロップダウンに「大阪湾エリア」が追加されていることを確認
- 選択すると「新しい堤防」が表示されることを確認

### 4. 削除をテスト
- AREAタブに戻る
- 追加したエリアのゴミ箱アイコンをクリック
- 確認ダイアログで「OK」
- 一覧から消えることを確認

---

## 🚀 デプロイ

### GitHub Actions
変更をプッシュすると、自動的にCloudflare Pagesにデプロイされます。

```bash
git add .
git commit -m "feat: Add area management feature"
git push origin main
```

### デプロイURL
- **練習用**: https://record-fishing-practice.pages.dev
- **本番**: https://record-fishing.pages.dev（変更なし）

---

## ⚠️ 注意事項

### 1. Supabaseデータベースは共有
- 練習用アプリと本番アプリは同じSupabaseデータベースを使用
- fishing_areas テーブルも同じデータベース内
- 練習用で追加したエリアは本番でも表示される可能性あり

### 2. 初期データの保護
- `is_default = true` のデータは削除不可
- RLSポリシーで保護されている

### 3. ユーザーごとのデータ
- `user_id` によって各ユーザーのデータを分離
- 他のユーザーのデータは見えない・編集できない

---

## 🎉 完成！

これで、釣果記録アプリに**完全なエリア管理機能**が追加されました！

ユーザーは自分の好きなエリア・場所・ポイントを自由に追加・削除できます。

既存の初期データは保護されているので、安心して使えます。

---

## 📚 関連ドキュメント

- [README.md](./README.md) - プロジェクト概要
- [SETUP_GUIDE.md](./SETUP_GUIDE.md) - セットアップガイド
- [QUICKSTART.md](./QUICKSTART.md) - クイックスタート
- [supabase_setup_v2.sql](./supabase_setup_v2.sql) - Supabaseテーブル作成SQL

---

## 🔗 リンク

- **練習用GitHub**: https://github.com/laurel-otoshikomi/record-fishing-practice
- **練習用アプリ**: https://record-fishing-practice.pages.dev
- **本番GitHub**: https://github.com/laurel-otoshikomi/record-fishing
- **本番アプリ**: https://record-fishing.pages.dev

---

**お疲れさまでした！ 🎣✨**
